<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>iOS Debug Console</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #000;
      color: #0f0;
      font-size: 12px;
      line-height: 1.4;
    }

    #debugContainer {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 60px;
      overflow-y: auto;
      padding: 10px;
      -webkit-overflow-scrolling: touch;
    }

    #debugControls {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1a1a1a;
      padding: 10px;
      display: flex;
      gap: 5px;
      border-top: 1px solid #333;
    }

    button {
      flex: 1;
      padding: 10px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    button:active {
      background: #555;
    }

    .log-entry {
      margin-bottom: 8px;
      padding: 8px;
      border-left: 3px solid #0f0;
      background: rgba(0, 255, 0, 0.05);
      word-wrap: break-word;
      font-size: 11px;
    }

    .log-error {
      border-left-color: #f00;
      background: rgba(255, 0, 0, 0.1);
      color: #f00;
    }

    .log-warn {
      border-left-color: #ff0;
      background: rgba(255, 255, 0, 0.1);
      color: #ff0;
    }

    .log-info {
      border-left-color: #0ff;
      background: rgba(0, 255, 255, 0.05);
      color: #0ff;
    }

    .log-time {
      color: #888;
      font-size: 10px;
      margin-right: 5px;
    }

    .log-type {
      display: inline-block;
      padding: 2px 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      margin-right: 5px;
      font-size: 10px;
      font-weight: bold;
    }

    #deviceInfo {
      background: #1a1a1a;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      font-size: 11px;
    }

    #deviceInfo div {
      margin-bottom: 5px;
    }

    #testArea {
      margin-top: 10px;
      padding: 10px;
      background: #1a1a1a;
      border-radius: 5px;
    }

    #testArea h3 {
      color: #0ff;
      margin-bottom: 10px;
      font-size: 14px;
    }

    #testArea button {
      margin-bottom: 5px;
      width: 100%;
    }

    .success {
      color: #0f0;
    }

    .failure {
      color: #f00;
    }
  </style>
</head>
<body>
  <div id="debugContainer">
    <div id="deviceInfo">
      <h3 style="color: #0ff; margin-bottom: 10px;">Device Information</h3>
      <div id="infoContent"></div>
    </div>

    <div id="testArea">
      <h3>Quick Tests</h3>
      <button onclick="testModal()">Test Modal Creation</button>
      <button onclick="testItemManager()">Test ItemManager</button>
      <button onclick="testSpinner()">Test Spinner</button>
      <button onclick="testShowResult()">Test showResult()</button>
      <button onclick="testStyles()">Test CSS Styles</button>
      <button onclick="testLocalStorage()">Test localStorage</button>
      <button onclick="causeError()">Cause Intentional Error</button>
    </div>

    <div id="logs"></div>
  </div>

  <div id="debugControls">
    <button onclick="clearLogs()">Clear</button>
    <button onclick="copyLogs()">Copy</button>
    <button onclick="toggleScroll()">Auto-Scroll: <span id="scrollStatus">ON</span></button>
  </div>

  <script src="js/storage.js"></script>
  <script src="js/items.js"></script>
  <script src="js/spinner.js"></script>
  <script src="js/app.js"></script>

  <script>
    // Debug Logger
    const DebugLogger = {
      container: null,
      autoScroll: true,
      logs: [],

      init() {
        this.container = document.getElementById('logs');
        this.showDeviceInfo();
        this.interceptConsole();
        this.interceptErrors();
        this.log('info', 'Debug console initialized');
      },

      interceptConsole() {
        const self = this;
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
          originalLog.apply(console, args);
          self.log('log', args.map(a => self.stringify(a)).join(' '));
        };

        console.error = function(...args) {
          originalError.apply(console, args);
          self.log('error', args.map(a => self.stringify(a)).join(' '));
        };

        console.warn = function(...args) {
          originalWarn.apply(console, args);
          self.log('warn', args.map(a => self.stringify(a)).join(' '));
        };
      },

      interceptErrors() {
        const self = this;

        window.addEventListener('error', (event) => {
          self.log('error', `ERROR: ${event.message} at ${event.filename}:${event.lineno}:${event.colno}`);
        });

        window.addEventListener('unhandledrejection', (event) => {
          self.log('error', `PROMISE REJECTION: ${event.reason}`);
        });
      },

      stringify(obj) {
        if (typeof obj === 'string') return obj;
        if (obj === null) return 'null';
        if (obj === undefined) return 'undefined';
        
        try {
          if (obj instanceof Error) {
            return `${obj.name}: ${obj.message}\n${obj.stack}`;
          }
          return JSON.stringify(obj, null, 2);
        } catch (e) {
          return String(obj);
        }
      },

      log(type, message) {
        const time = new Date().toLocaleTimeString('en-US', { 
          hour12: false,
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          fractionalSecondDigits: 3
        });

        const entry = {
          type,
          message,
          time,
          timestamp: Date.now()
        };

        this.logs.push(entry);

        const logDiv = document.createElement('div');
        logDiv.className = `log-entry log-${type}`;
        logDiv.innerHTML = `
          <span class="log-time">${time}</span>
          <span class="log-type">${type.toUpperCase()}</span>
          <div>${this.escapeHtml(message)}</div>
        `;

        this.container.appendChild(logDiv);

        if (this.autoScroll) {
          logDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }
      },

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML.replace(/\n/g, '<br>');
      },

      showDeviceInfo() {
        const info = {
          'User Agent': navigator.userAgent,
          'Platform': navigator.platform,
          'Language': navigator.language,
          'Screen Size': `${window.screen.width} x ${window.screen.height}`,
          'Viewport Size': `${window.innerWidth} x ${window.innerHeight}`,
          'Device Pixel Ratio': window.devicePixelRatio,
          'Touch Support': 'ontouchstart' in window,
          'iOS': /iPad|iPhone|iPod/.test(navigator.userAgent),
          'Safari': /Safari/.test(navigator.userAgent),
          'Cookies Enabled': navigator.cookieEnabled,
          'Online': navigator.onLine,
          'localStorage Available': (() => {
            try {
              localStorage.setItem('test', 'test');
              localStorage.removeItem('test');
              return true;
            } catch (e) {
              return false;
            }
          })(),
        };

        const infoContent = document.getElementById('infoContent');
        infoContent.innerHTML = Object.entries(info)
          .map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`)
          .join('');
      }
    };

    // Test Functions
    function testModal() {
      console.log('=== Testing Modal Creation ===');
      try {
        const modal = document.createElement('div');
        modal.id = 'testModal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.8);
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
        `;
        modal.innerHTML = '<div style="background: white; padding: 20px; border-radius: 10px;">Test Modal</div>';
        
        document.body.appendChild(modal);
        console.log('✅ Modal created successfully');
        
        setTimeout(() => {
          modal.remove();
          console.log('✅ Modal removed successfully');
        }, 2000);
      } catch (error) {
        console.error('❌ Modal creation failed:', error);
      }
    }

    function testItemManager() {
      console.log('=== Testing ItemManager ===');
      try {
        console.log('ItemManager exists:', typeof ItemManager !== 'undefined');
        
        if (typeof ItemManager !== 'undefined') {
          ItemManager.init();
          const items = ItemManager.getAllItems();
          console.log('✅ Items loaded:', items.length);
          console.log('Items:', JSON.stringify(items, null, 2));
        } else {
          console.error('❌ ItemManager not found');
        }
      } catch (error) {
        console.error('❌ ItemManager test failed:', error);
      }
    }

    function testSpinner() {
      console.log('=== Testing Spinner ===');
      try {
        console.log('Spinner exists:', typeof Spinner !== 'undefined');
        
        if (typeof Spinner !== 'undefined') {
          console.log('Spinner properties:', Object.keys(Spinner));
          console.log('✅ Spinner object loaded');
        } else {
          console.error('❌ Spinner not found');
        }
      } catch (error) {
        console.error('❌ Spinner test failed:', error);
      }
    }

    function testShowResult() {
      console.log('=== Testing showResult() ===');
      try {
        console.log('App exists:', typeof App !== 'undefined');
        
        if (typeof App !== 'undefined' && App.showResult) {
          console.log('Calling showResult with test data...');
          
          const testItem = {
            value: '₱1000',
            rarity: 'common'
          };
          
          App.showResult(testItem);
          console.log('✅ showResult() called successfully');
          
          // Check if result screen was created
          setTimeout(() => {
            const resultScreen = document.getElementById('resultScreen');
            if (resultScreen) {
              console.log('✅ Result screen found in DOM');
              console.log('Result screen styles:', resultScreen.getAttribute('style'));
            } else {
              console.error('❌ Result screen NOT found in DOM');
            }
          }, 500);
        } else {
          console.error('❌ App.showResult not found');
        }
      } catch (error) {
        console.error('❌ showResult test failed:', error);
      }
    }

    function testStyles() {
      console.log('=== Testing CSS Styles ===');
      try {
        const testDiv = document.createElement('div');
        testDiv.style.cssText = 'position: fixed; top: 0; left: 0;';
        document.body.appendChild(testDiv);
        
        const computed = window.getComputedStyle(testDiv);
        console.log('Position:', computed.position);
        console.log('Top:', computed.top);
        console.log('Left:', computed.left);
        
        testDiv.remove();
        console.log('✅ CSS styles working');
      } catch (error) {
        console.error('❌ CSS test failed:', error);
      }
    }

    function testLocalStorage() {
      console.log('=== Testing localStorage ===');
      try {
        localStorage.setItem('debug_test', 'test_value');
        const value = localStorage.getItem('debug_test');
        localStorage.removeItem('debug_test');
        
        console.log('✅ localStorage working, value:', value);
      } catch (error) {
        console.error('❌ localStorage failed:', error);
      }
    }

    function causeError() {
      console.log('=== Causing Intentional Error ===');
      try {
        // This will cause an error
        undefinedFunction();
      } catch (error) {
        console.error('Caught error:', error);
      }
      
      // This will cause an uncaught error
      setTimeout(() => {
        throw new Error('Intentional uncaught error for testing');
      }, 100);
    }

    function clearLogs() {
      const logsContainer = document.getElementById('logs');
      logsContainer.innerHTML = '';
      DebugLogger.logs = [];
      console.log('Logs cleared');
    }

    function copyLogs() {
      const logText = DebugLogger.logs
        .map(log => `[${log.time}] ${log.type.toUpperCase()}: ${log.message}`)
        .join('\n');
      
      // Try to copy to clipboard
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(logText).then(() => {
          alert('Logs copied to clipboard!');
        }).catch(() => {
          showLogsInAlert(logText);
        });
      } else {
        showLogsInAlert(logText);
      }
    }

    function showLogsInAlert(text) {
      // Fallback: show in textarea for manual copy
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.cssText = 'position: fixed; top: 50px; left: 10px; right: 10px; height: 70%; z-index: 20000; background: white; color: black; padding: 10px;';
      document.body.appendChild(textarea);
      textarea.select();
      
      const closeBtn = document.createElement('button');
      closeBtn.textContent = 'Close';
      closeBtn.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 20001; padding: 10px 20px;';
      closeBtn.onclick = () => {
        textarea.remove();
        closeBtn.remove();
      };
      document.body.appendChild(closeBtn);
    }

    function toggleScroll() {
      DebugLogger.autoScroll = !DebugLogger.autoScroll;
      document.getElementById('scrollStatus').textContent = DebugLogger.autoScroll ? 'ON' : 'OFF';
      console.log('Auto-scroll:', DebugLogger.autoScroll ? 'enabled' : 'disabled');
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      DebugLogger.init();
      console.log('=== Debug Console Ready ===');
      console.log('Run tests using the buttons above');
      console.log('All console.log, console.error, and console.warn will appear here');
    });
  </script>
</body>
</html>
